import{r as i,u as U,j as e,a5 as d,a7 as R,S,a9 as C,e as b,p as w,aJ as M,l as T,aK as D,aL as K,aM as F,aN as z,aO as N,aP as O,ac as V,t as v,ar as $,aQ as B,aR as G,b as Z,ad as q}from"./index--DjN_GCZ.js";import{R as E,S as J,B as P,C as L,T as A}from"./confirm-rrV5STMe.js";import{M as H}from"./myTable-gM2PRUcz.js";import"./useIcons-jgRnfhFH.js";function Q(I){const{closeModal:o,initValues:u,modalType:r,freshData:n}=I,[c,l]=i.useState([]),m=U(a=>a.user.token);function h(a){b(0,l),w({url:M,token:m,data:a}).then(s=>{s&&(o(),n())}).finally(()=>{T(0,l)})}function p(a){b(0,l),w({url:D,token:m,data:{...a,userId:u.userId}}).then(s=>{s&&(o(),n())}).finally(()=>{T(0,l)})}return e.jsx(e.Fragment,{children:e.jsxs(d,{name:"role-form",labelCol:{flex:"82px"},initialValues:u||{sex:3},onFinish:r==="edit"?p:h,children:[e.jsx(d.Item,{required:!0,label:"用户名",name:"username",rules:[{validator(a,s){const x=/^[a-zA-Z]/,j=/^[a-zA-Z][a-zA-Z0-9_-]{4,31}$/,y=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return new Promise((_,f)=>{s?y.test(s)?_(""):x.test(s)?j.test(s)?_(""):f("用户名应包含英文、数字，长度为5至32位"):f("用户名应以字母开始"):f("请输入用户名")})}}],children:e.jsx(R,{placeholder:"请输入用户名称",allowClear:!0})}),e.jsx(d.Item,{required:!0,label:"密码",name:"password",rules:[{validator(a,s){const x=/^\w{6,18}$/;return new Promise((j,y)=>{r==="edit"?j(""):s?x.test(s)?j(""):y("密码长度应为6-32位！"):y("请输入密码")})}}],children:e.jsx(R.Password,{disabled:r==="edit",placeholder:"请输入用户密码",allowClear:!0})}),e.jsx(d.Item,{label:"邮箱",name:"email",rules:[{validator(a,s){if(s){if(!/^[\w-.]+@([\w-]+\.)+[\w-]{2,4}$/.test(s))return Promise.reject("请输入有效的邮箱地址")}else return Promise.resolve();return Promise.resolve()}}],children:e.jsx(R,{placeholder:"请输入用户邮箱",allowClear:!0})}),e.jsx(d.Item,{label:"手机号",name:"phone",rules:[{validator:(a,s)=>{if(s){if(!/^1[3-9]\d{9}$/.test(s))return Promise.reject("请输入正确的手机号")}else return Promise.resolve();return Promise.resolve()}}],children:e.jsx(R,{placeholder:"请输入手机号",allowClear:!0})}),e.jsx(d.Item,{label:"性别",name:"sex",children:e.jsxs(E.Group,{children:[e.jsx(E,{value:1,children:"男"}),e.jsx(E,{value:2,children:"女"}),e.jsx(E,{value:3,children:"保密"})]})}),e.jsxs(S,{style:{width:"100%",justifyContent:"flex-end"},children:[e.jsx(C,{onClick:o,children:"取消"}),e.jsx(C,{type:"primary",htmlType:"submit",loading:c[0],children:r==="edit"?"更新":"添加"})]})]})})}function W(I){const{closeModal:o,initValues:u}=I,[r,n]=i.useState([]),c=U(s=>s.user.token),[l,m]=i.useState([]),[h]=d.useForm();function p(){b(1,n),w({url:K,data:{userId:u.userId},token:c}).then(s=>{h.setFieldValue("roleIds",s.content.hasRoles),m(F(z(s.content.rows),"roleId"))}).finally(()=>{T(1,n)})}function a(s){b(0,n),w({url:N,data:{...s,userId:u.userId},token:c}).then(()=>{o()}).finally(()=>{T(0,n)})}return i.useEffect(()=>{p()},[]),e.jsx(e.Fragment,{children:e.jsxs(d,{form:h,name:"user-role",onFinish:a,disabled:r[0],children:[e.jsx(d.Item,{className:"mb-3",name:"roleIds",children:e.jsx(J,{disabled:r[1],loading:r[1],mode:"multiple",allowClear:!0,options:l,placeholder:r[1]?"加载中...":"请选择您要分配的角色"})}),e.jsx(S,{wrap:!0,className:"w-full justify-end",children:e.jsx(C,{type:"primary",htmlType:"submit",loading:r[0],children:"保存分配"})})]})})}function te(){const[I,o]=i.useState(0),[u,r]=i.useState(!1),[n,c]=i.useState(),[l,m]=i.useState(),[h,p]=i.useState([]),a=U(t=>t.user.token),[s,x]=i.useState([]),j=[{title:"用户名称",width:160,dataIndex:"username",key:"username",fixed:"left",render:t=>t||"-"},{title:"状态",width:100,dataIndex:"status",key:"status",render:t=>e.jsx(A,{color:t===0?"":"green",children:t===0?"禁用":"正常"})},{title:"邮箱",width:200,dataIndex:"email",key:"email",render:t=>t||"-"},{title:"手机号",width:160,dataIndex:"phone",key:"phone",render:t=>t||"-"},{title:"性别",width:160,dataIndex:"sex",key:"sex",render:t=>e.jsx(A,{color:t===1?"blue":t===2?"pink":"",children:t===1?"男":t===2?"女":"保密"})},{title:"上次登录时间",width:200,dataIndex:"lastLoginTime",key:"lastLoginTime",render:t=>t?v(t):"-"},{title:"操作",width:230,fixed:"right",render:(t,g)=>e.jsxs(S,{size:"middle",children:[e.jsx(P,{permissionKey:"user:edit",size:"small",type:"link",onClick:()=>{c("edit"),m(g),f()},children:"编辑"}),e.jsx(P,{permissionKey:"user:assignRole",size:"small",onClick:()=>{c("assign"),m(g),f()},type:"link",children:"分配角色"}),e.jsx(L,{permissionKey:"user:delete",danger:!0,confirmTitle:"是否确认删除",buttonText:"删除",onConfirm:()=>{y(g.userId)}})]})}];function y(t){$({url:B,data:{userId:t},token:a}).then(g=>{g&&o(Math.random())})}function _(){b(1,x),w({url:G,token:a,data:Z({userIds:h})}).then(t=>{t&&o(Math.random())}).finally(()=>{T(1,x),p([])})}function f(){r(!0)}function k(){q(),m(void 0),r(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(S,{className:"mb-3",children:[e.jsx(P,{permissionKey:"user:add",type:"primary",onClick:()=>{f(),c("add")},children:"添加用户"}),e.jsx(L,{permissionKey:"user:batchDelete",danger:!0,disabled:h.length===0,buttonText:"批量删除",confirmTitle:"是否确认删除",onConfirm:_,loading:s[1],buttonType:"primary",size:"middle"})]}),e.jsx(H,{permissionKey:"user:batchDelete",rowKey:"userId",checked:!0,url:O,tableKey:I,columns:j,selectedRowKeys:h,setSelectedRowKeys:p}),e.jsx(V,{title:n==="edit"?"编辑用户":n==="assign"?e.jsxs(S,{children:["分配角色",e.jsxs(A,{color:"blue",className:"flex",children:["当前用户：",l==null?void 0:l.username]})]}):"新增用户",open:u,onCancel:k,centered:!0,footer:null,destroyOnClose:!0,children:n==="assign"?e.jsx(W,{closeModal:k,initValues:l}):e.jsx(Q,{closeModal:k,modalType:n,initValues:l,freshData:()=>{o(Math.random())}})})]})}export{te as default};
